name: Deploy to Staging and Production

on:
  push:
    branches:
      - main
      - release

jobs:
  # Build once and use for both environments
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        run: npm install -g pnpm@10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Build application
        run: pnpm build
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Package build artifact
        run: tar -czf next-build.tar.gz .next

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: next-build.tar.gz
          retention-days: 7

  # Deploy to staging automatically on main branch
  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.outcraftly.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: next-build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to staging server
        run: |
          # Upload build
          scp -i ~/.ssh/deploy_key next-build.tar.gz ubuntu@${{ secrets.SERVER_IP }}:/tmp/
          
          # Deploy on server
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            echo "üöÄ Deploying to staging..."
            
            # Stop PM2 apps
            pm2 delete staging-app staging-worker staging-reply || true
            
            # Navigate to staging directory
            cd /home/ubuntu/outcraftly-staging
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            
            # Extract new build
            rm -rf .next
            tar -xzf /tmp/next-build.tar.gz
            rm /tmp/next-build.tar.gz
            
            # Install dependencies (in case package.json changed)
            pnpm install --frozen-lockfile
            
            # Start services
            pm2 start ecosystem.staging.config.js
            pm2 save
            
            # Wait for app to be ready
            sleep 10
            
            # Verify deployment
            if pm2 list | grep -q "staging-app.*online"; then
              echo "‚úÖ Staging deployment successful!"
            else
              echo "‚ùå Staging app failed to start"
              pm2 logs staging-app --lines 50 --nostream
              exit 1
            fi
          EOF

      - name: Verify staging health
        run: |
          echo "üîç Checking staging health..."
          for i in {1..30}; do
            if curl -f -s https://staging.outcraftly.com > /dev/null; then
              echo "‚úÖ Staging is healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for staging to be ready..."
            sleep 10
          done
          echo "‚ùå Staging health check failed"
          exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Staging deployment completed successfully"
            echo "üåê Visit: https://staging.outcraftly.com"
            echo "üìù Test thoroughly before merging to release branch"
          else
            echo "‚ùå Staging deployment failed"
          fi

  # Deploy to production with manual approval
  deploy-production:
    needs: build
    if: github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.outcraftly.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: next-build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Create database backup
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "üì¶ Creating database backup..."
            BACKUP_FILE="/home/ubuntu/backups/db_backup_$(date +%Y%m%d_%H%M%S).sql"
            mkdir -p /home/ubuntu/backups
            
            # Extract database URL from production .env
            cd /home/ubuntu/outcraftly-production
            DB_URL=$(grep POSTGRES_URL .env | cut -d '=' -f2-)
            
            # Create backup using pg_dump
            echo "Creating backup: $BACKUP_FILE"
            pg_dump "$DB_URL" > "$BACKUP_FILE"
            gzip "$BACKUP_FILE"
            
            echo "‚úÖ Backup created: ${BACKUP_FILE}.gz"
            
            # Keep only last 7 backups
            cd /home/ubuntu/backups
            ls -t db_backup_*.sql.gz | tail -n +8 | xargs -r rm
            echo "üìù Backup retention: kept last 7 backups"
          EOF

      - name: Deploy to production server
        run: |
          # Upload build
          scp -i ~/.ssh/deploy_key next-build.tar.gz ubuntu@${{ secrets.SERVER_IP }}:/tmp/
          
          # Deploy on server
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            
            echo "üöÄ Deploying to production..."
            
            # Stop PM2 apps gracefully
            pm2 delete outcraftly-app outcraftly-worker outcraftly-reply || true
            
            # Navigate to production directory
            cd /home/ubuntu/outcraftly-production
            
            # Pull latest code
            git fetch origin release
            git reset --hard origin/release
            
            # Extract new build
            rm -rf .next
            tar -xzf /tmp/next-build.tar.gz
            rm /tmp/next-build.tar.gz
            
            # Install dependencies (in case package.json changed)
            pnpm install --frozen-lockfile
            
            # Start services
            pm2 start ecosystem.config.js
            pm2 save
            
            # Wait for app to be ready
            sleep 15
            
            # Verify deployment
            if pm2 list | grep -q "outcraftly-app.*online"; then
              echo "‚úÖ Production deployment successful!"
            else
              echo "‚ùå Production app failed to start"
              pm2 logs outcraftly-app --lines 50 --nostream
              exit 1
            fi
          EOF

      - name: Verify production health
        run: |
          echo "üîç Checking production health..."
          for i in {1..30}; do
            if curl -f -s https://app.outcraftly.com > /dev/null; then
              echo "‚úÖ Production is healthy!"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for production to be ready..."
            sleep 10
          done
          echo "‚ùå Production health check failed"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/deploy_key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
            set -e
            echo "‚ö†Ô∏è  Deployment failed, initiating rollback..."
            
            cd /home/ubuntu/outcraftly-production
            
            # Stop current processes
            pm2 delete outcraftly-app outcraftly-worker outcraftly-reply || true
            
            # Restore from latest backup if available
            LATEST_BACKUP=$(ls -t /home/ubuntu/backups/db_backup_*.sql.gz 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "üì¶ Restoring database from: $LATEST_BACKUP"
              DB_URL=$(grep POSTGRES_URL .env | cut -d '=' -f2-)
              gunzip -c "$LATEST_BACKUP" | psql "$DB_URL"
            fi
            
            # Revert to previous commit
            git reset --hard HEAD~1
            
            # Restart with previous version
            pm2 start ecosystem.config.js
            pm2 save
            
            echo "‚úÖ Rollback completed"
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Production deployment completed successfully"
            echo "üåê Live at: https://app.outcraftly.com"
          else
            echo "‚ùå Production deployment failed and rolled back"
          fi

  # Cleanup old artifacts
  cleanup:
    needs: [deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Delete build artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: next-build
