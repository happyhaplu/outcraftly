# Copilot Instructions for Outcraftly

## Project Overview
- **Framework:** Next.js (app directory, server components, middleware)
- **Database:** PostgreSQL via Drizzle ORM
- **Payments:** Stripe integration (webhooks, customer portal)
- **UI:** shadcn/ui library
- **Auth:** JWT-based, cookies, RBAC (Owner/Member)

## Key Workflows
- **Local Dev:**
  - `pnpm install` to set up dependencies
  - `pnpm db:setup` to generate `.env`
  - `pnpm db:migrate` and `pnpm db:seed` to initialize database
  - `pnpm dev` to start Next.js server
- **Stripe Webhooks:**
  - Use `stripe listen --forward-to localhost:3000/api/stripe/webhook` for local testing
- **Workers:**
  - Sequence worker: `pnpm worker:run [--limit <count>] [--team <teamId>]`
  - Trial expiry: `pnpm trial:expire`
  - Both require correct env vars (`SEQUENCE_WORKER_SECRET`, `BASE_URL`, DB config)
- **Migrations:**
  - SQL files in `lib/db/migrations/`
  - Use Drizzle Kit or manual SQL execution

## Architectural Patterns
- **App Structure:**
  - Pages/routes in `app/` (e.g., `/dashboard`, `/login`, `/api`)
  - UI components in `components/ui/`
  - Business logic in `lib/` and `lib/auth/`, `lib/services/`, etc.
- **Middleware:**
  - Global route protection in `middleware.ts`
  - Local validation via Zod schemas
- **RBAC:**
  - Owner/Member roles enforced in dashboard and API
- **Sequence Lifecycle:**
  - Sequences start as Draft, launched via dashboard
  - Drafts cannot accept enrollments

## Conventions & Patterns
- **Environment:** Use `.env` generated by setup script
- **Testing:**
  - Payments: Use Stripe test cards (`4242 4242 4242 4242`)
  - E2E: Playwright specs in `e2e/`
- **Logging:**
  - Activity logging for user events
- **Cron Jobs:**
  - Sequence worker and trial expiry automated via Vercel Cron or similar

## Integration Points
- **Stripe:** API routes for webhooks (`/api/stripe/webhook`)
- **Database:** Postgres connection via Drizzle config (`drizzle.config.ts`)
- **External Automation:** Cron jobs for workers, trial expiry

## Examples
- To run sequence worker manually:
  ```bash
  pnpm worker:run --limit 10 --team abc123
  ```
- To expire trials:
  ```bash
  pnpm trial:expire
  ```
- To apply migrations:
  ```bash
  pnpm db:migrate
  ```

---
_If any section is unclear or missing, please provide feedback for improvement._
